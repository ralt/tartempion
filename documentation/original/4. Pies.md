4. Pies
===

4.1. Introduction
---

A pie is an entity. It is similar to an app in django. Or a mojito in mojito.

A pie has one controller and one model.

tartempion uses the concept of a pie so that you can have decoupled business code.
This way, you can code your "user" pie for a project, and reuse this pie in another
project, by simply copy pasting it. Rumors say that someone is thinking of building
a pie package manager.

Don't forget that tartempion relies on express to do its work. So you will see some
similarities.

4.2. Definition
---

You can define the pies used in the `pies.json` file. By default, the CLI utility
does this for you, so you may not need it. But here is how a pie is defined:

    {
        "pieName": {
            "path": "path/to/pieName"
        }
    }

`path/to/pieName` starts at the `pies/` folder.

If you want to use a pie in another pie, this is where you define the dependencies.
Here is an example:

    {
        "pieName" {
            "path": "pieName"
        },
        "otherPie": {
            "path": "otherPie",
            "dependencies": [
                "pieName"
            ]
        }
    }

You will see in 4.4. how to use these dependencies.

4.3. The routes
---

To define the routes that a pie handles, the `routes.json` file is there.

tartempion believes that writing JSON files is less prone to errors than writing
code, so it tries to use them as much as possible.

Here is a sample of a `routes.json` file:

    {
        "get": [
            { "/": "index" },
            { "/user/login": {
                "method": "getLogin",
                "middlewares": [
                    "requireGuest"
                ]}
            }
        ],
        "post": [
            { "/user/login": {
                "method": "postLogin",
                "middlewares": [
                    "requireGuest"
                ]}
            },
            { "/user/logout": {
                "method": "logout",
                "middlewares": [
                    "requireLogged"
                ]}
            }
        ]
    }

You can see how such a file is structured:

- There are two main array properties: `get` and `post`.
- These arrays contain objects defining each route.
- Each object has the route as a key.
- The value can be either a string or a method.
    - If it's a string, it is the controller's method used to handle the route.
    - If it's an object, this object has two properties:
        - The `method` property defines the controller's method.
        - The `middlewares` property is an array of the middlewares used.

4.4. The controllers
---

As you could see, we defined the controller's methods in the `routes.json` file.
These controller's methods are to be found in the `controller.js` file of the pie.

To follow the example of 4.2., here is a controller's example:

    module.exports = {
        getLogin: function( req, res ) {
        },

        postLogin: function( req, res ) {
        },

        logout: function( req, res ) {
        }
    };

Each controller's method has two parameters:

- `req`: the request parameter.
- `res`: the response parameter.

Now, there is something very important to know:

**Each controller has its model's methods available through `this.model`.**

This means that after defining a `get( username, callback )` method in the model,
you can use it this way in the controller:

    module.exports = {
        getLogin: function( req, res ) {

            // See the very important thing here:
            this.model.get( req.params.username, function() {} );
        });
    };

And it works.

If you have defined dependencies in the `pies.json` file, you can access the other
pie's controller methods through `this.pieName`.

4.5. The models
---

The model's methods are defined in the `model.js` file of a pie.

To follow up on the previous example, here is the `model.js` file:

    module.exports = {
        get: function( username, callback ) {
            // Use "this.db" to access the database
            // specified in the configuration.
            callback();
        }
    };

You saw that comment right. You can access the methods of your database
through `this.db`. Just like this.

